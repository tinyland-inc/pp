# CI/CD Pipeline for prompt-pulse
# Standalone repo extracted from crush-dots monorepo.
# Nix flake builds + traditional Go CI for lint, test, and cross-compiled releases.
stages:
  - check
  - lint
  - test
  - build
  - publish
  - cache

variables:
  ATTIC_SERVER: "https://nix-cache.fuzzy-dev.tinyland.dev"
  ATTIC_CACHE: "prompt-pulse"
  ATTIC_PUBLIC_KEY: "tinyland-lab:wX4VELFLU2s+MwmbenLd6YPz79mbO1+XE4YzZl5WqBc="
  GO_VERSION: "1.25"
  GOPATH: ${CI_PROJECT_DIR}/.go
  GOCACHE: ${CI_PROJECT_DIR}/.go-cache
  GOMODCACHE: ${CI_PROJECT_DIR}/.go-mod-cache

# =============================================================================
# Reusable Templates
# =============================================================================

.go-cache:
  cache:
    key: "go-${CI_COMMIT_REF_SLUG}"
    paths:
      - .go-mod-cache/
      - .go-cache/
      - vendor/
    policy: pull-push

.go-base:
  image: golang:${GO_VERSION}-alpine
  before_script:
    - apk add --no-cache git
  variables:
    CGO_ENABLED: "0"

# =============================================================================
# Check Stage (Nix)
# =============================================================================

check:flake:
  image: nixos/nix:2.24.9
  stage: check
  tags: [tinyland, docker]
  timeout: 5 minutes
  variables:
    NIX_CONFIG: "experimental-features = nix-command flakes"
  before_script:
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
  script:
    - nix flake check --no-build
    - nix flake metadata --json | head -20
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_ID

# =============================================================================
# Lint Stage
# =============================================================================

lint:vet:
  stage: lint
  extends:
    - .go-base
    - .go-cache
  script:
    - go vet ./...
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_ID
  tags:
    - docker

lint:fmt:
  stage: lint
  extends:
    - .go-base
    - .go-cache
  script:
    - |
      DIFF=$(gofmt -d .)
      if [ -n "$DIFF" ]; then
        echo "Code is not formatted. Run 'gofmt -w .'"
        echo "$DIFF"
        exit 1
      fi
      echo "All files properly formatted"
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_ID
  tags:
    - docker

lint:golangci:
  stage: lint
  image: golangci/golangci-lint:v1.62-alpine
  extends:
    - .go-cache
  script:
    - golangci-lint run --timeout 5m ./...
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_ID
  tags:
    - docker

# =============================================================================
# Test Stage
# =============================================================================

test:unit:
  stage: test
  extends:
    - .go-base
    - .go-cache
  needs:
    - job: lint:vet
      optional: true
      artifacts: false
    - job: lint:fmt
      optional: true
      artifacts: false
  script:
    - go test ./... -v -count=1 -coverprofile=coverage.out -covermode=atomic -timeout 5m
    - go tool cover -func=coverage.out | tee coverage-summary.txt
    - go tool cover -func=coverage.out | tail -1
    - |
      COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | tr -d '%')
      echo "COVERAGE=${COVERAGE}" >> metrics.env
      echo "Total coverage: ${COVERAGE}%"
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  artifacts:
    paths:
      - coverage.out
      - coverage-summary.txt
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.out
      dotenv: metrics.env
    when: always
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_ID
  tags:
    - docker

test:race:
  stage: test
  extends:
    - .go-base
    - .go-cache
  variables:
    CGO_ENABLED: "1"
  before_script:
    - apk add --no-cache git gcc musl-dev
  needs:
    - job: lint:vet
      optional: true
      artifacts: false
  script:
    - go test -race -short ./... -timeout 5m
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_ID
  tags:
    - docker

# =============================================================================
# Build Stage - Nix flake builds (primary)
# =============================================================================

.nix_build_base:
  image: nixos/nix:2.24.9
  stage: build
  timeout: 20 minutes
  variables:
    NIX_CONFIG: |
      experimental-features = nix-command flakes
      extra-substituters = ${ATTIC_SERVER}/${ATTIC_CACHE} ${ATTIC_SERVER}/main https://cache.nixos.org
      extra-trusted-public-keys = ${ATTIC_PUBLIC_KEY} main:NKRk1XYo/dfd9fcDqgotUJg2DTDHWp5ny+Ba7WzRjgE= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
      connect-timeout = 5
      fallback = true
  before_script:
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_MERGE_REQUEST_ID
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+/

build:x86_64-linux:
  extends: .nix_build_base
  tags: [tinyland, nix, shell, x86_64-linux]
  script:
    - nix build .#packages.x86_64-linux.default -o result-x86_64-linux --print-build-logs
    - result-x86_64-linux/bin/prompt-pulse --version || result-x86_64-linux/bin/prompt-pulse version || true
  artifacts:
    paths: [result-x86_64-linux]
    expire_in: 1 day

build:aarch64-darwin:
  extends: .nix_build_base
  tags: [tinyland, darwin-native]
  script:
    - nix build .#packages.aarch64-darwin.default -o result-aarch64-darwin --print-build-logs
    - result-aarch64-darwin/bin/prompt-pulse --version || result-aarch64-darwin/bin/prompt-pulse version || true
  artifacts:
    paths: [result-aarch64-darwin]
    expire_in: 1 day

# =============================================================================
# Build Stage - Cross-compiled Go binaries (for releases)
# =============================================================================

.go-build-base:
  stage: build
  extends:
    - .go-base
    - .go-cache
  needs:
    - job: test:unit
      optional: true
      artifacts: false
  script:
    - mkdir -p dist
    - |
      VERSION="${CI_COMMIT_TAG:-$(git describe --tags --always 2>/dev/null || echo 'dev')}"
      VERSION="${VERSION#v}"
      LDFLAGS="-s -w \
        -X main.Version=${VERSION} \
        -X main.version=${VERSION} \
        -X main.Commit=${CI_COMMIT_SHA:-$(git rev-parse HEAD)} \
        -X main.commit=$(git rev-parse --short HEAD) \
        -X main.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
        -X main.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)"

      echo "Building for ${GOOS}/${GOARCH}..."
      GOOS=${GOOS} GOARCH=${GOARCH} go build \
        -ldflags "${LDFLAGS}" \
        -o "dist/prompt-pulse-${GOOS}-${GOARCH}${EXT}" .

      ls -lh "dist/prompt-pulse-${GOOS}-${GOARCH}${EXT}"

      cd dist
      sha256sum "prompt-pulse-${GOOS}-${GOARCH}${EXT}" > "prompt-pulse-${GOOS}-${GOARCH}${EXT}.sha256"
  artifacts:
    paths:
      - dist/
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+/
    - if: $CI_COMMIT_BRANCH == "main"
  tags:
    - docker

build:go:linux-amd64:
  extends: .go-build-base
  variables:
    GOOS: linux
    GOARCH: amd64

build:go:linux-arm64:
  extends: .go-build-base
  variables:
    GOOS: linux
    GOARCH: arm64

build:go:darwin-amd64:
  extends: .go-build-base
  variables:
    GOOS: darwin
    GOARCH: amd64

build:go:darwin-arm64:
  extends: .go-build-base
  variables:
    GOOS: darwin
    GOARCH: arm64

# =============================================================================
# Publish Stage
# =============================================================================

publish:package:
  stage: publish
  image: alpine:latest
  needs:
    - job: build:go:linux-amd64
      artifacts: true
    - job: build:go:linux-arm64
      artifacts: true
    - job: build:go:darwin-amd64
      artifacts: true
    - job: build:go:darwin-arm64
      artifacts: true
  before_script:
    - apk add --no-cache coreutils
  script:
    - |
      echo "Artifacts ready for release:"
      ls -la dist/
      cd dist
      cat *.sha256 > checksums.txt
      echo ""
      echo "Checksums:"
      cat checksums.txt
  artifacts:
    paths:
      - dist/
    expire_in: 90 days
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+/
    - if: $CI_COMMIT_BRANCH == "main"
  tags:
    - docker

publish:release:
  stage: publish
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: publish:package
      artifacts: true
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}"
  release:
    tag_name: ${CI_COMMIT_TAG}
    name: "prompt-pulse ${CI_COMMIT_TAG#v}"
    description: |
      ## prompt-pulse ${CI_COMMIT_TAG#v}

      Shell monitoring dashboard with Claude API, cloud billing, and infrastructure tracking.

      ### Downloads

      | Platform | Architecture | Binary |
      |----------|--------------|--------|
      | Linux    | amd64        | [prompt-pulse-linux-amd64](${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-linux-amd64?job=build:go:linux-amd64) |
      | Linux    | arm64        | [prompt-pulse-linux-arm64](${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-linux-arm64?job=build:go:linux-arm64) |
      | macOS    | amd64 (Intel)| [prompt-pulse-darwin-amd64](${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-darwin-amd64?job=build:go:darwin-amd64) |
      | macOS    | arm64 (Apple Silicon) | [prompt-pulse-darwin-arm64](${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-darwin-arm64?job=build:go:darwin-arm64) |

      ### Checksums

      See `checksums.txt` in the release artifacts for SHA256 hashes.

      ### Installation

      ```bash
      # Download and install (example for Linux amd64)
      curl -L "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-linux-amd64?job=build:go:linux-amd64" -o prompt-pulse
      chmod +x prompt-pulse
      mv prompt-pulse ~/.local/bin/
      ```
    assets:
      links:
        - name: "prompt-pulse-linux-amd64"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-linux-amd64?job=build:go:linux-amd64"
          filepath: "/binaries/prompt-pulse-linux-amd64"
          link_type: package
        - name: "prompt-pulse-linux-arm64"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-linux-arm64?job=build:go:linux-arm64"
          filepath: "/binaries/prompt-pulse-linux-arm64"
          link_type: package
        - name: "prompt-pulse-darwin-amd64"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-darwin-amd64?job=build:go:darwin-amd64"
          filepath: "/binaries/prompt-pulse-darwin-amd64"
          link_type: package
        - name: "prompt-pulse-darwin-arm64"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-darwin-arm64?job=build:go:darwin-arm64"
          filepath: "/binaries/prompt-pulse-darwin-arm64"
          link_type: package
        - name: "checksums.txt"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/checksums.txt?job=publish:package"
          filepath: "/checksums.txt"
          link_type: other
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+/
  tags:
    - docker

# =============================================================================
# Cache Stage (Attic/Nix)
# =============================================================================

cache:attic:
  image: nixos/nix:2.24.9
  stage: cache
  tags: [tinyland, docker]
  timeout: 10 minutes
  variables:
    NIX_CONFIG: "experimental-features = nix-command flakes"
  before_script:
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
    - |
      if [ -n "$ATTIC_TOKEN" ]; then
        nix profile install nixpkgs#attic-client 2>/dev/null || nix-env -iA nixpkgs.attic-client || true
        mkdir -p ~/.config/attic
        cat > ~/.config/attic/config.toml << EOF
      [servers.default]
      endpoint = "${ATTIC_SERVER}"
      token = "${ATTIC_TOKEN}"
      EOF
      fi
  script:
    - |
      if [ -z "$ATTIC_TOKEN" ]; then
        echo "ATTIC_TOKEN not set, skipping"
        exit 0
      fi
      for result in result-*; do
        [ -e "$result" ] && attic push "${ATTIC_CACHE}" "$result" --jobs 4 || true
      done
  needs:
    - job: build:x86_64-linux
      optional: true
      artifacts: true
    - job: build:aarch64-darwin
      optional: true
      artifacts: true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+/
  allow_failure: true
