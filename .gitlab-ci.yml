# =============================================================================
# GitLab CI/CD Pipeline for prompt-pulse
# =============================================================================
# Multi-stage Go CI: lint, test (with race detector + coverage), cross-compile
# builds for linux/amd64, linux/arm64, darwin/amd64, and darwin/arm64.
#
# Included from the root .gitlab-ci.yml via:
#   include:
#     - local: 'cmd/prompt-pulse/.gitlab-ci.yml'
#
# Trigger: Changes to cmd/prompt-pulse/** or manual run
#
# Stages used (defined in ci/templates/dag-stages.yml):
#   - lint   (go vet, gofmt, golangci-lint)
#   - test   (go test -race -cover)
#   - build  (cross-compiled binaries)
#   - publish (package artifacts, create releases)
# =============================================================================

variables:
  PROMPT_PULSE_GOVERSION: "1.24"
  PROMPT_PULSE_SRC: "cmd/prompt-pulse"
  # Go module and build caching
  GOPATH: ${CI_PROJECT_DIR}/.go
  GOCACHE: ${CI_PROJECT_DIR}/.go-cache
  GOMODCACHE: ${CI_PROJECT_DIR}/.go-mod-cache

# =============================================================================
# Reusable Templates
# =============================================================================

# Change-detection rules scoped to prompt-pulse source tree
# Skips draft MRs and WIP commits
.prompt-pulse-rules:
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_MERGE_REQUEST_TITLE =~ /^Draft:/
      when: never
    - if: $CI_MERGE_REQUEST_TITLE =~ /^WIP:/
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - cmd/prompt-pulse/**/*
      when: always
    - if: $CI_MERGE_REQUEST_ID
      changes:
        - cmd/prompt-pulse/**/*
      when: always
    - if: $CI_COMMIT_TAG =~ /^prompt-pulse-/
      when: always
    - when: manual
      allow_failure: true

# Go module + build cache shared across jobs on the same branch
.prompt-pulse-cache:
  cache:
    key: "prompt-pulse-${CI_COMMIT_REF_SLUG}"
    paths:
      - .go-mod-cache/
      - .go-cache/
      - cmd/prompt-pulse/vendor/
    policy: pull-push

# Base image for all Go jobs
.prompt-pulse-go-base:
  image: golang:${PROMPT_PULSE_GOVERSION}-alpine
  extends:
    - .retry_transient
  before_script:
    - apk add --no-cache git make
    - cd ${PROMPT_PULSE_SRC}
  variables:
    CGO_ENABLED: "0"

# =============================================================================
# Lint Stage
# =============================================================================

lint:prompt-pulse:vet:
  stage: lint
  extends:
    - .prompt-pulse-go-base
    - .prompt-pulse-rules
    - .prompt-pulse-cache
  script:
    - go vet ./...
  tags:
    - docker

lint:prompt-pulse:fmt:
  stage: lint
  extends:
    - .prompt-pulse-go-base
    - .prompt-pulse-rules
    - .prompt-pulse-cache
  script:
    - |
      DIFF=$(gofmt -d .)
      if [ -n "$DIFF" ]; then
        echo "Code is not formatted. Run 'gofmt -w .'"
        echo "$DIFF"
        exit 1
      fi
      echo "All files properly formatted"
  tags:
    - docker

lint:prompt-pulse:golangci:
  stage: lint
  image: golangci/golangci-lint:v1.62-alpine
  extends:
    - .prompt-pulse-rules
    - .prompt-pulse-cache
  before_script:
    - cd ${PROMPT_PULSE_SRC}
  script:
    - golangci-lint run --timeout 5m ./...
  allow_failure: true  # Advisory until config is tuned
  tags:
    - docker

# =============================================================================
# Test Stage
# =============================================================================

test:prompt-pulse:unit:
  stage: test
  extends:
    - .prompt-pulse-go-base
    - .prompt-pulse-rules
    - .prompt-pulse-cache
  needs:
    - job: lint:prompt-pulse:vet
      optional: true
      artifacts: false
    - job: lint:prompt-pulse:fmt
      optional: true
      artifacts: false
  script:
    - go test ./... -v -count=1 -race -coverprofile=coverage.out -covermode=atomic -timeout 5m
    - go tool cover -func=coverage.out | tee coverage-summary.txt
    - go tool cover -func=coverage.out | tail -1
    - |
      # Extract total coverage percentage for metrics
      COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | tr -d '%')
      echo "COVERAGE=${COVERAGE}" >> metrics.env
      echo "Total coverage: ${COVERAGE}%"
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  artifacts:
    paths:
      - cmd/prompt-pulse/coverage.out
      - cmd/prompt-pulse/coverage-summary.txt
    reports:
      coverage_report:
        coverage_format: cobertura
        path: cmd/prompt-pulse/coverage.out
      dotenv: cmd/prompt-pulse/metrics.env
    when: always
    expire_in: 30 days
  tags:
    - docker

test:prompt-pulse:race:
  stage: test
  extends:
    - .prompt-pulse-go-base
    - .prompt-pulse-rules
    - .prompt-pulse-cache
  variables:
    CGO_ENABLED: "1"  # Race detector requires CGO
  before_script:
    - apk add --no-cache git make gcc musl-dev
    - cd ${PROMPT_PULSE_SRC}
  needs:
    - job: lint:prompt-pulse:vet
      optional: true
      artifacts: false
  script:
    - go test -race -short ./... -timeout 5m
  tags:
    - docker

# =============================================================================
# Build Stage - Cross-compiled binaries
# =============================================================================

.prompt-pulse-build-base:
  stage: build
  extends:
    - .prompt-pulse-go-base
    - .prompt-pulse-rules
    - .prompt-pulse-cache
  needs:
    - job: test:prompt-pulse:unit
      optional: true
      artifacts: false
  script:
    - mkdir -p ../../dist
    - |
      VERSION="${CI_COMMIT_TAG:-$(git describe --tags --always 2>/dev/null || echo 'dev')}"
      VERSION="${VERSION#prompt-pulse-}"  # Strip prefix if present
      LDFLAGS="-s -w \
        -X main.Version=${VERSION} \
        -X main.version=${VERSION} \
        -X main.Commit=${CI_COMMIT_SHA:-$(git rev-parse HEAD)} \
        -X main.commit=$(git rev-parse --short HEAD) \
        -X main.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
        -X main.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)"

      echo "Building for ${GOOS}/${GOARCH}..."
      GOOS=${GOOS} GOARCH=${GOARCH} go build \
        -ldflags "${LDFLAGS}" \
        -o "../../dist/prompt-pulse-${GOOS}-${GOARCH}${EXT}" .

      ls -lh "../../dist/prompt-pulse-${GOOS}-${GOARCH}${EXT}"

      # Generate checksum
      cd ../../dist
      sha256sum "prompt-pulse-${GOOS}-${GOARCH}${EXT}" > "prompt-pulse-${GOOS}-${GOARCH}${EXT}.sha256"
  artifacts:
    paths:
      - dist/
    expire_in: 30 days
  tags:
    - docker

build:prompt-pulse:linux-amd64:
  extends: .prompt-pulse-build-base
  variables:
    GOOS: linux
    GOARCH: amd64

build:prompt-pulse:linux-arm64:
  extends: .prompt-pulse-build-base
  variables:
    GOOS: linux
    GOARCH: arm64

build:prompt-pulse:darwin-amd64:
  extends: .prompt-pulse-build-base
  variables:
    GOOS: darwin
    GOARCH: amd64

build:prompt-pulse:darwin-arm64:
  extends: .prompt-pulse-build-base
  variables:
    GOOS: darwin
    GOARCH: arm64

# Optional Nix build - only runs if flake.nix exists
build:prompt-pulse:nix:
  stage: build
  image: nixos/nix:latest
  extends:
    - .prompt-pulse-rules
  before_script:
    - nix-env -iA nixpkgs.git
    - cd ${PROMPT_PULSE_SRC}
  script:
    - |
      if [ -f flake.nix ]; then
        echo "Building with Nix flake..."
        nix build .#prompt-pulse --extra-experimental-features "nix-command flakes"
        mkdir -p ../../dist
        cp -L result/bin/prompt-pulse ../../dist/prompt-pulse-nix || true
      else
        echo "No flake.nix found, skipping Nix build"
        exit 0
      fi
  artifacts:
    paths:
      - dist/
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - cmd/prompt-pulse/**/*
        - cmd/prompt-pulse/flake.nix
      exists:
        - cmd/prompt-pulse/flake.nix
    - if: $CI_COMMIT_TAG =~ /^prompt-pulse-/
      exists:
        - cmd/prompt-pulse/flake.nix
  allow_failure: true
  tags:
    - docker

# =============================================================================
# Publish Stage
# =============================================================================

publish:prompt-pulse:package:
  stage: publish
  image: alpine:latest
  needs:
    - job: build:prompt-pulse:linux-amd64
      artifacts: true
    - job: build:prompt-pulse:linux-arm64
      artifacts: true
    - job: build:prompt-pulse:darwin-amd64
      artifacts: true
    - job: build:prompt-pulse:darwin-arm64
      artifacts: true
  before_script:
    - apk add --no-cache coreutils
  script:
    - |
      echo "Artifacts ready for release:"
      ls -la dist/

      # Generate combined checksums file
      cd dist
      cat *.sha256 > checksums.txt
      echo ""
      echo "Checksums:"
      cat checksums.txt
  artifacts:
    paths:
      - dist/
    expire_in: 90 days
  rules:
    - if: $CI_COMMIT_TAG =~ /^prompt-pulse-/
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - cmd/prompt-pulse/**/*
  tags:
    - docker

# Create GitLab release on tags matching prompt-pulse-*
publish:prompt-pulse:release:
  stage: publish
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: publish:prompt-pulse:package
      artifacts: true
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}"
  release:
    tag_name: ${CI_COMMIT_TAG}
    name: "prompt-pulse ${CI_COMMIT_TAG#prompt-pulse-}"
    description: |
      ## prompt-pulse ${CI_COMMIT_TAG#prompt-pulse-}

      Shell prompt integration for Claude Code usage metrics.

      ### Downloads

      | Platform | Architecture | Binary |
      |----------|--------------|--------|
      | Linux    | amd64        | [prompt-pulse-linux-amd64](${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-linux-amd64?job=build:prompt-pulse:linux-amd64) |
      | Linux    | arm64        | [prompt-pulse-linux-arm64](${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-linux-arm64?job=build:prompt-pulse:linux-arm64) |
      | macOS    | amd64 (Intel)| [prompt-pulse-darwin-amd64](${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-darwin-amd64?job=build:prompt-pulse:darwin-amd64) |
      | macOS    | arm64 (Apple Silicon) | [prompt-pulse-darwin-arm64](${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-darwin-arm64?job=build:prompt-pulse:darwin-arm64) |

      ### Checksums

      See `checksums.txt` in the release artifacts for SHA256 hashes.

      ### Installation

      ```bash
      # Download and install (example for Linux amd64)
      curl -L "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-linux-amd64?job=build:prompt-pulse:linux-amd64" -o prompt-pulse
      chmod +x prompt-pulse
      mv prompt-pulse ~/.local/bin/
      ```
    assets:
      links:
        - name: "prompt-pulse-linux-amd64"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-linux-amd64?job=build:prompt-pulse:linux-amd64"
          filepath: "/binaries/prompt-pulse-linux-amd64"
          link_type: package
        - name: "prompt-pulse-linux-arm64"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-linux-arm64?job=build:prompt-pulse:linux-arm64"
          filepath: "/binaries/prompt-pulse-linux-arm64"
          link_type: package
        - name: "prompt-pulse-darwin-amd64"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-darwin-amd64?job=build:prompt-pulse:darwin-amd64"
          filepath: "/binaries/prompt-pulse-darwin-amd64"
          link_type: package
        - name: "prompt-pulse-darwin-arm64"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/prompt-pulse-darwin-arm64?job=build:prompt-pulse:darwin-arm64"
          filepath: "/binaries/prompt-pulse-darwin-arm64"
          link_type: package
        - name: "checksums.txt"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/dist/checksums.txt?job=publish:prompt-pulse:package"
          filepath: "/checksums.txt"
          link_type: other
  rules:
    - if: $CI_COMMIT_TAG =~ /^prompt-pulse-/
  tags:
    - docker
